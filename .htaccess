# Apache configuration for React SPA + API
# Handles routing, CORS, compression, and security

# Enable mod_rewrite for URL routing
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Set base URL - adjust if app is in subdirectory
    RewriteBase /

    # Prevent rewrite loop
    RewriteCond %{ENV:REWRITE_PROCESSED} ^$
    RewriteRule ^ - [E=REWRITE_PROCESSED:1]

    # Skip rewriting for existing files
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]

    # Skip rewriting for existing directories
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Skip rewriting for /api.php requests
    RewriteRule ^api\.php - [L]

    # Skip rewriting for PHP files and scripts directory
    RewriteCond %{REQUEST_FILENAME} !\.php$
    RewriteCond %{REQUEST_FILENAME} !^scripts/
    RewriteCond %{REQUEST_FILENAME} !^public/

    # Rewrite all other requests to index.html for SPA routing
    RewriteRule ^ index.html [QSA,L]
</IfModule>

# Disable directory listing for security
<IfModule mod_autoindex.c>
    Options -Indexes
</IfModule>

# Enable gzip compression
<IfModule mod_deflate.c>
    # Compress text files
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json

    # Don't compress already-compressed files (images, video, etc)
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|ico|woff2|ttf|eot)$ no-gzip
</IfModule>

# Set proper MIME types
AddType application/json .json
AddType application/javascript .js
AddType text/css .css
AddEncoding gzip .json

# Caching headers for production assets
<IfModule mod_headers.c>
    # Cache versioned assets (hashed filenames from Vite) for 1 year
    <FilesMatch "\.(js|css|woff|woff2|ttf|eot|ico|svg|png|jpg|jpeg|gif)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Don't cache HTML files (SPA bootstrap)
    <FilesMatch "\.html$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
    </FilesMatch>

    # Don't cache JSON or PHP
    <FilesMatch "\.(json|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </FilesMatch>

    # Security headers
    Header always unset "X-Powered-By"
    Header always unset "Server"
    Header always set "X-Content-Type-Options" "nosniff"
    Header always set "X-Frame-Options" "DENY"
    Header always set "X-XSS-Protection" "1; mode=block"
    Header always set "Referrer-Policy" "strict-origin-when-cross-origin"

    # Remove pragma header
    Header always unset "Pragma"
    Header always unset "Expires"
</IfModule>

# Ensure api.php is accessible
<FilesMatch "^api\.php$">
    <IfModule mod_fcgid.c>
        SetHandler fcgid-script
    </IfModule>
    <IfModule mod_php7.c>
        AddHandler application/x-httpd-php7 .php
    </IfModule>
    <IfModule mod_php.c>
        AddHandler application/x-httpd-php .php
    </IfModule>
</FilesMatch>

# Handle PHP files
<FilesMatch "\.php$">
    <IfModule mod_fcgid.c>
        SetHandler fcgid-script
    </IfModule>
    <IfModule mod_php7.c>
        AddHandler application/x-httpd-php7 .php
    </IfModule>
    <IfModule mod_php.c>
        AddHandler application/x-httpd-php .php
    </IfModule>
</FilesMatch>

# Protect sensitive files
<FilesMatch "\.(env|sql|log|conf|config|yml|yaml)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Allow access to uploads directory
<Directory "uploads">
    <IfModule mod_rewrite.c>
        RewriteEngine Off
    </IfModule>
    Order allow,deny
    Allow from all
</Directory>

# Default character encoding
AddDefaultCharset UTF-8
