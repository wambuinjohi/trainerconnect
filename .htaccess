# Enable mod_rewrite
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Preserve the protocol for CORS (important for production)
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ - [E=PROTOCOL:http]
    RewriteCond %{HTTPS} on
    RewriteRule ^(.*)$ - [E=PROTOCOL:https]
</IfModule>

# Enable CORS headers via mod_headers (if available)
<IfModule mod_headers.c>
    # Allow CORS from specific origins
    Header always set "Access-Control-Allow-Origin" "https://trainer.skatryk.co.ke"
    Header always set "Access-Control-Allow-Methods" "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    Header always set "Access-Control-Allow-Headers" "Content-Type, Authorization, X-Admin-Token, X-Admin-Actor, X-Requested-With"
    Header always set "Access-Control-Max-Age" "86400"
    Header always set "Access-Control-Allow-Credentials" "true"
    
    # Cache control
    Header always set "Cache-Control" "no-cache, no-store, must-revalidate, max-age=0"
    Header always set "Pragma" "no-cache"
    Header always set "Expires" "0"
    
    # Handle preflight requests
    <IfModule mod_rewrite.c>
        RewriteRule ^(.*)$ $1 [R=200,L]
    </IfModule>
</IfModule>

# Disable directory listing
<IfModule mod_autoindex.c>
    Options -Indexes
</IfModule>

# Prevent direct access to sensitive files
<FilesMatch "\.php$">
    # Allow access to api.php only
    <IfModule mod_rewrite.c>
        RewriteCond %{REQUEST_URI} !^/api\.php$
        RewriteCond %{REQUEST_URI} !^/public/.*\.php$
        RewriteRule \.(php)$ - [F,L]
    </IfModule>
</FilesMatch>

# Use PHP-FPM if available
<IfModule mod_fcgid.c>
    SetHandler fcgid-script
</IfModule>

# Enable gzip compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>

# Ensure JSON requests are handled properly
AddType application/json .json
AddEncoding gzip .json
